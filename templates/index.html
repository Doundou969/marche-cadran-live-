<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>March√© au Cadran LIVE | Agriculture 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #1da1f2; /* Wave Blue */
            --orange: #ff6600;    /* Orange Money */
            --danger: #e63946;
            --bg: #f4f7f6;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 10px;
            color: #333;
        }

        header {
            text-align: center;
            padding: 20px 0;
            background: white;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .auction-card {
            background: #ffffff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 18px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            border-top: 6px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        .copernicus-badge {
            display: inline-block;
            background: #e8f5e9;
            color: var(--primary);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .price {
            font-size: 3.2em;
            font-weight: 800;
            color: var(--danger);
            margin: 5px 0;
            letter-spacing: -1px;
        }

        .unit { font-size: 0.4em; color: #666; }

        .timer {
            font-size: 1.1em;
            color: #f77f00;
            background: #fff3e0;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            padding: 14px;
            font-size: 0.95em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s, opacity 0.2s;
        }

        button:active { transform: scale(0.98); }

        .btn-wave { background: var(--secondary); color: white; }
        .btn-orange { background: var(--orange); color: white; }
        
        .sold-status {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #ccc;
        }

        .verified {
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1em;
        }

        .btn-receipt {
            background: var(--primary);
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .reference {
            font-family: monospace;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>

<body>

<header>
    <h1>üü¢ March√© Live</h1>
    <p>Syst√®me d√©gressif certifi√© Copernicus</p>
</header>

<div class="container" id="lots-container">
    <p style="text-align: center;">Connexion au march√© en cours...</p>
</div>

<script>
    function refreshLots() {
        fetch('/lots')
            .then(res => res.json())
            .then(data => {
                let html = "";
                data.forEach(lot => {
                    html += `
                    <div class="auction-card">
                        <span class="copernicus-badge">üõ∞ NDVI Copernicus: ${lot.ndvi}</span>
                        <h3 style="margin: 0; color: #2c3e50;">${lot.product}</h3>
                        <p style="color: #666; font-size: 0.9em;">Quantit√© : <strong>${lot.quantity}</strong></p>

                        <div class="price">${lot.current_price}<span class="unit"> FCFA/kg</span></div>
                        
                        ${!lot.winner ? `<div class="timer">‚è± Temps restant: ${lot.time_left}s</div>` : ''}

                        ${lot.winner ? renderSoldState(lot) : renderActionButtons(lot)}
                    </div>`;
                });
                document.getElementById("lots-container").innerHTML = html;
            })
            .catch(err => console.error("Erreur de synchro:", err));
    }

    function renderActionButtons(lot) {
        if (!lot.active) {
            return `<p style="text-align:center; color:#999;">Lot en attente de d√©marrage...</p>`;
        }
        return `
            <div class="actions">
                <button class="btn-wave" onclick="buyLot('${lot.id}','wave')">üíô WAVE</button>
                <button class="btn-orange" onclick="buyLot('${lot.id}','orange')">üü† ORANGE</button>
            </div>
        `;
    }

    function renderSoldState(lot) {
        if (lot.winner === "Lot retir√© (Prix min)") {
            return `<div class="sold-status" style="color:red">‚ùå Non vendu (Prix plancher atteint)</div>`;
        }

        return `
            <div class="sold-status">
                <span class="verified">üî® R√âSERV√â PAR ${lot.winner}</span><br>
                <small>R√©f: <span class="reference">${lot.payment.reference}</span></small>
                
                ${lot.confirmed ? 
                    `<p style="color:var(--primary); margin:5px 0;">‚úÖ PAIEMENT CONFIRM√â</p>
                     <button class="btn-receipt" onclick="window.open('/receipt/${lot.id}')">üìÑ VOIR MON RE√áU</button>` : 
                    `<p style="color:#f77f00; margin:5px 0;">‚è≥ Validation admin en cours...</p>`
                }
            </div>
        `;
    }

    function buyLot(id, method) {
        fetch('/buy/' + id, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ buyer: 'Acheteur Mobile', method: method })
        })
        .then(res => res.json())
        .then(data => {
            if(data.error) {
                alert(data.error);
            } else {
                alert(
                    "üõí TRANSACTION INITIALIS√âE\n\n" +
                    "M√©thode : " + data.method.toUpperCase() + "\n" +
                    "Montant : " + data.amount + " FCFA/kg\n" +
                    "R√©f√©rence : " + data.reference + "\n\n" +
                    "Effectuez le transfert puis attendez la validation."
                );
            }
        });
    }

    // Mise √† jour toutes les secondes pour le cadran
    setInterval(refreshLots, 1000);
    refreshLots();
</script>

</body>
</html>
